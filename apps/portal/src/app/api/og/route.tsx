import { ImageResponse } from "next/og";

async function loadAssets(): Promise<
  { name: string; data: Buffer; weight: 400 | 600; style: "normal" }[]
  > {
  try {
    const [
      { base64Font: normal },
      { base64Font: mono },
      { base64Font: semibold },
    ] = await Promise.all([
      import("./geist-regular-otf.json").then((mod) => mod.default || mod),
      import("./geistmono-regular-otf.json").then((mod) => mod.default || mod),
      import("./geist-semibold-otf.json").then((mod) => mod.default || mod),
    ]);
    
    return [
      {
        name: "Geist",
        data: Buffer.from(normal, "base64"),
        weight: 400 as const,
        style: "normal" as const,
      },
      {
        name: "Geist Mono",
        data: Buffer.from(mono, "base64"),
        weight: 400 as const,
        style: "normal" as const,
      },
      {
        name: "Geist",
        data: Buffer.from(semibold, "base64"),
        weight: 600 as const,
        style: "normal" as const,
      },
    ];
    } catch (error) {
      console.error('Failed to load fonts:', error);
       return []; // Return empty array to use system fonts as fallback
    }
}

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const title = searchParams.get("title")?.slice(0, 100) || "Foneflip";
  const description = searchParams.get("description")?.slice(0, 200) || "";

  const [fonts] = await Promise.all([loadAssets()]);

  const response = new ImageResponse(
    (
      <div
        tw="flex h-full w-full bg-black text-white"
        style={{ fontFamily: "Geist Sans" }}
      >
        <div tw="flex border absolute border-stone-700 border-dashed inset-y-0 left-16 w-[1px]" />
        <div tw="flex border absolute border-stone-700 border-dashed inset-y-0 right-16 w-[1px]" />
        <div tw="flex border absolute border-stone-700 inset-x-0 h-[1px] top-16" />
        <div tw="flex border absolute border-stone-700 inset-x-0 h-[1px] bottom-16" />
        <div tw="flex absolute flex-row bottom-24 right-24 text-white">
          <svg
            width="139"
            height="42"
            viewBox="0 0 139 42"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M28.2124 0H16.7394C15.8985 0 15.2167 0.67952 15.2167 1.51769V15.7217H16.1117V1.51769C16.1117 1.17344 16.394 0.892057 16.7394 0.892057H28.2124C28.5578 0.892057 28.8401 1.17344 28.8401 1.51769V20.4574C28.8401 20.8017 28.5578 21.0831 28.2124 21.0831H16.7394C16.394 21.0831 16.1117 20.8017 16.1117 20.4574V18.9367H15.2167V20.4574C15.2167 21.2956 15.8985 21.9781 16.7394 21.9781H28.2124C29.0533 21.9781 29.7351 21.2956 29.7351 20.4574V1.51769C29.7351 0.67952 29.0533 0 28.2124 0Z"
              fill="url(#paint0_linear_1035_5419)"
            />
            <path
              d="M25.5544 6.6096V6.78023L22.9564 14.3178C22.6651 15.156 21.8722 15.7217 20.9832 15.7217H12.2343C11.3423 15.7217 10.5494 16.2845 10.2611 17.1257L6.42275 28.2674C5.77702 30.1383 3.11902 30.1383 2.47329 28.2674L0.112627 21.4064C-0.0375424 20.9693 -0.0375424 20.4934 0.112627 20.0563L4.26031 8.01354C4.55164 7.17237 5.34454 6.6096 6.23354 6.6096H25.5544Z"
              fill="#4A3AFF"
            />
            <path
              d="M33.8017 18.9367V19.1074L31.2037 26.6449C30.9124 27.4861 30.1195 28.0489 29.2305 28.0489H20.4816C19.5896 28.0489 18.7967 28.6147 18.5084 29.4528L14.6701 40.5946C14.0273 42.4685 11.3663 42.4685 10.7206 40.5946L8.35994 33.7365C8.20977 33.2965 8.20977 32.8235 8.35994 32.3834L12.5076 20.3437C12.799 19.5055 13.5919 18.9397 14.4809 18.9397H33.8017V18.9367Z"
              fill="#962DFF"
            />
            <path
              d="M20.4606 2.67916H24.8486C24.973 2.67916 25.0738 2.57865 25.0738 2.45465V2.18823C25.0738 2.06424 24.973 1.96372 24.8486 1.96372H20.4606C20.3362 1.96372 20.2354 2.06424 20.2354 2.18823V2.45465C20.2354 2.57865 20.3362 2.67916 20.4606 2.67916Z"
              fill="url(#paint1_linear_1035_5419)"
            />
            <path
              d="M42.8509 11.022V11.4351H47.2178V14.6621H42.8509V27.4203H39.1087V9.80963C39.1087 6.84908 41.157 4.98414 44.0973 4.98414H48.6114V8.38773H45.4939C43.4756 8.38773 42.8509 9.18698 42.8509 11.022Z"
              fill="#4A3AFF"
            />
            <path
              d="M65.07 19.4307C65.07 24.0795 61.4449 27.8663 56.5764 27.8663C51.7079 27.8663 48.1128 24.0765 48.1128 19.4307C48.1128 14.7848 51.7349 10.9651 56.5764 10.9651C61.4179 10.9651 65.07 14.7549 65.07 19.4307ZM61.2076 19.4307C61.2076 16.8563 59.6038 14.4585 56.5734 14.4585C53.543 14.4585 51.9692 16.8563 51.9692 19.4307C51.9692 22.0051 53.573 24.3729 56.5734 24.3729C59.5738 24.3729 61.2076 21.9751 61.2076 19.4307Z"
              fill="#4A3AFF"
            />
            <path
              d="M81.91 17.5957V27.4233H78.1978V18.2452C78.1978 15.6709 76.3868 14.2789 74.4256 14.2789C72.2571 14.2789 70.1187 16.084 70.1187 19.2211V27.4203H66.3765V11.4081H70.1187V14.7249C71.3351 12.387 73.4465 10.9651 75.732 10.9651C78.9697 10.9651 81.91 13.1863 81.91 17.5957Z"
              fill="#4A3AFF"
            />
            <path
              d="M97.7439 21.8584C97.7439 25.8247 95.2481 27.8693 90.8841 27.8693C86.0727 27.8693 83.1324 24.2861 83.1324 19.4337C83.1324 13.6892 87.0818 11.2345 90.7069 10.9681C95.0138 10.6717 97.4496 12.833 97.4496 15.7936C97.4496 17.5388 96.975 18.9308 94.5993 19.9665L87.8868 22.8073C88.5685 23.8431 89.5807 24.4058 90.737 24.4058C92.488 24.4058 93.8545 23.6664 93.8545 21.8614H97.7469L97.7439 21.8584ZM87.0518 20.1132L92.5751 17.7453C93.1998 17.4789 93.7043 17.1826 93.7043 16.4132C93.7043 15.141 92.4579 14.3118 91.0313 14.3118C89.1602 14.3118 87.0218 15.7337 87.0218 19.4337C87.0218 19.6701 87.0218 19.8767 87.0518 20.1132Z"
              fill="#4A3AFF"
            />
            <path
              d="M103 11.022V11.4351H107.367V14.6621H103V27.4203H99.2576V9.80963C99.2576 6.84908 101.306 4.98414 104.246 4.98414H108.76V8.38773H105.643C103.625 8.38773 103 9.18698 103 11.022Z"
              fill="#962DFF"
            />
            <path
              d="M110.367 27.4233V4.98414H114.109V27.4233H110.367Z"
              fill="#962DFF"
            />
            <path
              d="M115.89 7.14543C115.89 5.96002 116.842 4.98414 118.029 4.98414C119.215 4.98414 120.167 5.96002 120.167 7.14543C120.167 8.33085 119.215 9.27679 118.029 9.27679C116.842 9.27679 115.89 8.30091 115.89 7.14543ZM116.158 27.4233V11.4381H119.9V27.4233H116.158Z"
              fill="#962DFF"
            />
            <path
              d="M131.427 27.8663C128.754 27.8663 126.736 26.3845 125.693 24.5226V33.9969H121.951V11.4081H125.693V14.3088C126.733 12.4439 128.754 10.9651 131.427 10.9651C141.524 10.9651 141.524 27.8693 131.427 27.8693V27.8663ZM130.475 14.3388C127.207 14.3388 125.693 16.9431 125.693 19.4307C125.693 21.9182 127.207 24.4926 130.475 24.4926C136.593 24.4926 136.593 14.3388 130.475 14.3388Z"
              fill="#962DFF"
            />
            <path
              d="M38.9014 30.9705H40.2139C40.5473 30.9705 40.7996 31.0364 40.9768 31.1681C41.151 31.2998 41.2411 31.4764 41.2411 31.6949C41.2411 31.8446 41.208 31.9703 41.136 32.0751C41.0669 32.1799 40.9738 32.2607 40.8596 32.3176C40.7425 32.3745 40.6194 32.4044 40.4812 32.4044L40.5533 32.2607C40.7095 32.2607 40.8506 32.2877 40.9768 32.3475C41.1029 32.4074 41.199 32.4882 41.2711 32.596C41.3432 32.7038 41.3792 32.8385 41.3792 33.0031C41.3792 33.2426 41.2891 33.4282 41.1059 33.5599C40.9227 33.6916 40.6524 33.7575 40.295 33.7575H38.9014V30.9705ZM39.421 33.3473H40.262C40.4542 33.3473 40.6014 33.3144 40.7065 33.2516C40.8116 33.1887 40.8627 33.0869 40.8627 32.9462C40.8627 32.8055 40.8116 32.7067 40.7065 32.6409C40.6014 32.575 40.4542 32.5421 40.262 32.5421H39.379V32.141H40.1539C40.3311 32.141 40.4692 32.108 40.5683 32.0452C40.6674 31.9823 40.7155 31.8865 40.7155 31.7578C40.7155 31.6291 40.6674 31.5303 40.5683 31.4674C40.4692 31.4046 40.3311 31.3717 40.1539 31.3717H39.421V33.3473Z"
              fill="#353435"
            />
            <path
              d="M43.9351 33.7934C43.5537 33.7934 43.2564 33.6856 43.0401 33.4701C42.8239 33.2545 42.7157 32.9432 42.7157 32.5361V30.9675H43.2353V32.5182C43.2353 32.8055 43.2984 33.0121 43.4215 33.1438C43.5447 33.2725 43.7189 33.3384 43.9471 33.3384C44.1754 33.3384 44.3466 33.2725 44.4697 33.1438C44.5929 33.0151 44.6529 32.8055 44.6529 32.5182V30.9675H45.1635V32.5361C45.1635 32.9432 45.0554 33.2575 44.8391 33.4701C44.6229 33.6826 44.3226 33.7934 43.9381 33.7934H43.9351Z"
              fill="#353435"
            />
            <path
              d="M47.329 33.7545V32.6529L47.4491 32.9672L46.2327 30.9705H46.7823L47.7644 32.581H47.4521L48.4312 30.9705H48.9418L47.7284 32.9672L47.8455 32.6529V33.7545H47.329Z"
              fill="#353435"
            />
            <path
              d="M55.7805 34.5268V30.8029H56.24V34.5268H55.7805Z"
              fill="#353435"
            />
            <path
              d="M64.3522 33.7934C64.1329 33.7934 63.9257 33.7634 63.7275 33.7006C63.5293 33.6377 63.3701 33.5569 63.2499 33.4611L63.4301 33.06C63.5413 33.1468 63.6794 33.2216 63.8446 33.2785C64.0098 33.3384 64.178 33.3653 64.3522 33.3653C64.4994 33.3653 64.6165 33.3503 64.7066 33.3174C64.7967 33.2845 64.8628 33.2426 64.9048 33.1887C64.9469 33.1348 64.9679 33.0719 64.9679 33.0031C64.9679 32.9193 64.9378 32.8504 64.8748 32.7995C64.8147 32.7486 64.7336 32.7067 64.6375 32.6768C64.5414 32.6469 64.4333 32.6169 64.3131 32.593C64.193 32.569 64.0759 32.5361 63.9587 32.5002C63.8416 32.4643 63.7305 32.4164 63.6344 32.3595C63.5383 32.3026 63.4572 32.2248 63.3971 32.132C63.337 32.0362 63.307 31.9135 63.307 31.7668C63.307 31.6201 63.346 31.4764 63.4301 31.3507C63.5112 31.225 63.6344 31.1232 63.8026 31.0484C63.9677 30.9735 64.181 30.9346 64.4363 30.9346C64.6045 30.9346 64.7697 30.9556 64.9348 30.9975C65.1 31.0394 65.2442 31.1022 65.3673 31.1801L65.2051 31.5812C65.079 31.5064 64.9499 31.4525 64.8177 31.4166C64.6856 31.3806 64.5564 31.3627 64.4333 31.3627C64.2921 31.3627 64.178 31.3806 64.0849 31.4136C63.9948 31.4495 63.9287 31.4944 63.8867 31.5513C63.8446 31.6081 63.8236 31.671 63.8236 31.7398C63.8236 31.8237 63.8536 31.8925 63.9137 31.9434C63.9738 31.9943 64.0518 32.0362 64.1479 32.0661C64.2441 32.0961 64.3522 32.123 64.4723 32.15C64.5925 32.1769 64.7096 32.2068 64.8267 32.2428C64.9439 32.2787 65.052 32.3236 65.1511 32.3805C65.2502 32.4373 65.3283 32.5122 65.3884 32.608C65.4484 32.7038 65.4785 32.8235 65.4785 32.9672C65.4785 33.1109 65.4364 33.2516 65.3553 33.3803C65.2742 33.506 65.1511 33.6078 64.9829 33.6826C64.8147 33.7575 64.6045 33.7964 64.3492 33.7964L64.3522 33.7934Z"
              fill="#353435"
            />
            <path
              d="M67.3135 33.3174H68.8903V33.7545H66.7939V30.9705H68.8332V31.4076H67.3135V33.3174ZM67.2745 32.129H68.662V32.5541H67.2745V32.129Z"
              fill="#353435"
            />
            <path
              d="M70.2659 33.7545V30.9705H70.7854V33.3174H72.2451V33.7545H70.2659Z"
              fill="#353435"
            />
            <path
              d="M73.4555 33.7545V30.9705H73.9751V33.3174H75.4347V33.7545H73.4555Z"
              fill="#353435"
            />
            <path
              d="M82.3425 34.5268V30.8029H82.802V34.5268H82.3425Z"
              fill="#353435"
            />
            <path
              d="M90.5688 33.3174H92.1456V33.7545H90.0492V30.9705H92.0885V31.4076H90.5688V33.3174ZM90.5297 32.129H91.9173V32.5541H90.5297V32.129Z"
              fill="#353435"
            />
            <path
              d="M93.1487 33.7545L94.326 32.135V32.5301L93.1998 30.9705H93.7914L94.6294 32.12H94.3861L95.212 30.9705H95.7737L94.6594 32.5032V32.129L95.8397 33.7545H95.2451L94.3681 32.5301H94.6023L93.7374 33.7545H93.1457H93.1487Z"
              fill="#353435"
            />
            <path
              d="M98.2455 33.7934C98.0292 33.7934 97.831 33.7575 97.6508 33.6886C97.4706 33.6198 97.3114 33.518 97.1793 33.3893C97.0441 33.2605 96.942 33.1079 96.8669 32.9372C96.7918 32.7666 96.7558 32.575 96.7558 32.3655C96.7558 32.1559 96.7918 31.9644 96.8669 31.7937C96.942 31.6201 97.0471 31.4704 97.1823 31.3417C97.3174 31.213 97.4766 31.1112 97.6568 31.0424C97.837 30.9705 98.0352 30.9376 98.2515 30.9376C98.4797 30.9376 98.69 30.9765 98.8792 31.0543C99.0684 31.1322 99.2276 31.2489 99.3567 31.4016L99.0203 31.7159C98.9182 31.6081 98.8011 31.5243 98.6779 31.4704C98.5518 31.4166 98.4197 31.3896 98.2755 31.3896C98.1313 31.3896 97.9962 31.4136 97.873 31.4615C97.7529 31.5094 97.6478 31.5782 97.5577 31.665C97.4676 31.7518 97.3985 31.8566 97.3475 31.9763C97.2964 32.0961 97.2724 32.2278 97.2724 32.3715C97.2724 32.5152 97.2964 32.6469 97.3475 32.7666C97.3985 32.8864 97.4676 32.9881 97.5577 33.0779C97.6478 33.1647 97.7529 33.2336 97.873 33.2815C97.9932 33.3294 98.1283 33.3533 98.2755 33.3533C98.4227 33.3533 98.5548 33.3264 98.6779 33.2725C98.8041 33.2186 98.9182 33.1348 99.0203 33.0241L99.3567 33.3384C99.2276 33.491 99.0684 33.6078 98.8792 33.6886C98.69 33.7694 98.4797 33.8083 98.2485 33.8083L98.2455 33.7934Z"
              fill="#353435"
            />
            <path
              d="M101.171 33.7545H100.651V30.9705H101.171V33.7545ZM102.654 32.5601H101.129V32.12H102.654V32.5601ZM102.615 30.9675H103.129V33.7515H102.615V30.9675Z"
              fill="#353435"
            />
            <path
              d="M104.288 33.7545L105.547 30.9705H106.057L107.319 33.7545H106.772L105.694 31.2459H105.901L104.82 33.7545H104.288ZM104.868 33.1109L105.012 32.7038H106.517L106.655 33.1109H104.868Z"
              fill="#353435"
            />
            <path
              d="M108.472 33.7545V30.9705H108.898L110.649 33.1198H110.439V30.9705H110.95V33.7545H110.523L108.775 31.6051H108.986V33.7545H108.472Z"
              fill="#353435"
            />
            <path
              d="M113.806 33.7934C113.587 33.7934 113.389 33.7575 113.205 33.6886C113.022 33.6198 112.863 33.518 112.728 33.3893C112.593 33.2605 112.488 33.1079 112.412 32.9372C112.337 32.7666 112.301 32.575 112.301 32.3655C112.301 32.1559 112.337 31.9644 112.412 31.7937C112.488 31.6201 112.593 31.4704 112.731 31.3417C112.869 31.213 113.028 31.1112 113.208 31.0424C113.392 30.9705 113.593 30.9376 113.818 30.9376C114.043 30.9376 114.266 30.9765 114.455 31.0543C114.644 31.1322 114.806 31.2429 114.935 31.3926L114.608 31.7099C114.5 31.6021 114.38 31.5213 114.254 31.4704C114.127 31.4195 113.989 31.3926 113.836 31.3926C113.683 31.3926 113.551 31.4166 113.428 31.4644C113.304 31.5123 113.196 31.5812 113.106 31.668C113.016 31.7548 112.944 31.8596 112.896 31.9793C112.845 32.0991 112.821 32.2308 112.821 32.3745C112.821 32.5182 112.845 32.6469 112.896 32.7666C112.947 32.8864 113.016 32.9911 113.106 33.0779C113.196 33.1647 113.304 33.2336 113.425 33.2815C113.545 33.3294 113.683 33.3533 113.833 33.3533C113.971 33.3533 114.106 33.3324 114.233 33.2875C114.362 33.2426 114.485 33.1707 114.602 33.066L114.893 33.4521C114.749 33.5689 114.581 33.6557 114.392 33.7155C114.202 33.7754 114.004 33.8053 113.806 33.8053V33.7934ZM114.41 33.3713V32.3326H114.896V33.4371L114.41 33.3683V33.3713Z"
              fill="#353435"
            />
            <path
              d="M116.9 33.3174H118.476V33.7545H116.38V30.9705H118.419V31.4076H116.9V33.3174ZM116.86 32.129H118.248V32.5541H116.86V32.129Z"
              fill="#353435"
            />
            <defs>
              <linearGradient
                id="paint0_linear_1035_5419"
                x1="139.863"
                y1="40.4555"
                x2="132.42"
                y2="-11.5522"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#962DFF" />
                <stop offset="1" stop-color="#4A3AFF" />
              </linearGradient>
              <linearGradient
                id="paint1_linear_1035_5419"
                x1="0"
                y1="20.9121"
                x2="139.086"
                y2="20.9121"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#962DFF" />
                <stop offset="1" stop-color="#4A3AFF" />
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div tw="flex flex-col absolute w-[896px] justify-center inset-32">
          <div
            tw="tracking-tight flex-grow-1 flex flex-col justify-center leading-[0.9]"
            style={{
              textWrap: "balance",
              fontWeight: 600,
              fontSize:
                title && title.length > 40
                  ? 42
                  : title && title.length > 20
                    ? 60
                    : 80,
              letterSpacing: "-0.04em",
            }}
          >
            {title}
          </div>
          <div
            tw=" leading-[1.5] flex-grow-1 text-stone-400 mt-3 tracking-tight"
            style={{
              fontWeight: 500,
              textWrap: "balance",
              fontSize: description && description.length > 20 ? 24 : 36,
            }}
          >
            {description}
          </div>
        </div>
      </div>
    ),
    {
      width: 1200,
      height: 628,
      fonts,
    }
  );
  // Add caching headers
  response.headers.set('Cache-Control', 'public, max-age=31536000, immutable');
  return response;
}
